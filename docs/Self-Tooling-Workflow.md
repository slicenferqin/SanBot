# SanBot Self-Tooling 工作流手册

## 目标
Self-Tooling 的目标不是“多造工具”，而是把高频且重复的能力缺口沉淀为可复用工具，减少 Agent 在同类任务中的重复推理和风险操作。

参考实现：`src/tools/self-tool.ts`、`src/tools/tool-registry-center.ts`。

## 适用范围
- 任务中出现明确能力缺口，且可被脚本化解决（解析、转换、批处理、校验、汇总）。
- 同类任务预计会重复出现 3 次以上。
- 现有内置工具（`exec/read/write/edit/glob/grep`）不能直接满足。

不建议创建工具的场景：
- 一次性任务，且实现复杂度高于手工操作。
- 需要强权限或高风险操作但无可靠校验链路。
- 业务规则仍频繁变化，无法稳定抽象。

## 标准流程（V1）

### 1) 缺口检测（Detect）
触发信号：
1. Agent 在最近对话里反复执行类似命令拼接。
2. 同类错误反复出现（参数格式、文件结构、输出清洗）。
3. 用户明确提出“希望以后自动做这件事”。

输出产物：
- 一条缺口描述（问题、输入、期望输出、成功标准）。
- 风险分级（safe / warning / danger / critical）。

### 2) 方案设计（Design）
定义工具最小接口：
- `name`: 小写+下划线，表达动作和对象，例如 `csv_normalizer`。
- `description`: 用“输入→输出”格式描述。
- `parameters`: JSON Schema，明确必填参数、默认值和边界。

建议模板：
```json
{
  "type": "object",
  "properties": {
    "input": { "type": "string", "description": "输入文件路径" },
    "output": { "type": "string", "description": "输出文件路径" }
  },
  "required": ["input"]
}
```

### 3) 生成与注册（Build + Register）
通过 `create_tool` 写入脚本并注册。

当前实现行为（`src/tools/self-tool.ts`）：
- 自动补齐 shebang（python/bash）。
- 写入 `~/.sanbot/tools/<name>` 并赋予可执行权限。
- 将定义写入工具中心注册表。
- 尝试执行 `--help/-h` 做基本可执行性验证。

### 4) 自测与验收（Verify）
最低验收要求：
1. **正常路径**：给定标准输入能输出预期结构。
2. **失败路径**：输入缺失/格式错误时返回可理解错误信息。
3. **幂等性**：重复执行不会造成破坏性副作用（若适用）。

建议补充：
- 为每个工具准备 1 个“金样例输入”和“预期输出”。
- 在文档中记录运行命令与结果。

### 5) 上线与复用（Adopt）
上线后要求：
- 在后续类似任务中优先使用 `run_tool`。
- 记录使用频次、成功率、常见报错。
- 连续低成功率工具进入“整改/下架”流程。

## 元数据建议（下一步增强）
建议在工具注册表增加字段：
- `version`: 工具版本（如 `0.1.0`）。
- `tags`: 领域标签（`data`, `doc`, `qa`）。
- `lastUsedAt`: 最近使用时间。
- `successCount` / `failureCount`: 成功失败计数。
- `owner`: 创建来源（user/system/agent）。

## 风险与治理
- 高风险工具必须走确认流程，遵循危险命令检测与审计机制。
- 对 `rm`, `sudo`, 网络下载等操作应显式提示并最小权限执行。
- 工具输出不要默认覆盖关键文件，优先写入新文件并让用户确认替换。

## 今日可落地动作
1. 在 WebUI 增加“工具创建记录”视图（来源、成功率、最近错误）。
2. 给 `create_tool` 增加可选 `testCommand` 参数，统一测试入口。
3. 在审计日志中标注工具创建/运行事件，形成完整追溯链路。
